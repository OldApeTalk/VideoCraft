# 音频合成视频功能说明

## 📋 功能概述

`text2Video.py` 已重构为双标签页应用：
- **标签页 1**：文本转音频（Gemini-TTS）
- **标签页 2**：音频合成视频 ✨ 新功能

## 🎬 音频合成视频功能

### 功能描述
将静态图片和音频文件合成为视频，视频时长自动匹配音频长度。适用于：
- 制作音频封面视频（用于上传到视频平台）
- 生成简单的背景视频配乐
- 快速将音频内容可视化

### 使用步骤

1. **选择音频文件**
   - 点击"选择音频"按钮
   - 支持格式：MP3, WAV, M4A, AAC, OGG, FLAC
   - 自动显示文件名和时长

2. **选择图片文件**
   - 点击"选择图片"按钮
   - 支持格式：JPG, JPEG, PNG, BMP, GIF, WEBP
   - 自动显示图片尺寸信息

3. **选择视频方向** ✨ 新增
   - **横屏 (16:9)**：适用于常规视频平台
   - **竖屏 (9:16)**：适用于短视频平台（抖音、快手、视频号等）

4. **配置视频参数**
   - **分辨率**（根据视频方向自动切换）：
     - 横屏模式：
       - 1920x1080 (1080p) - 推荐
       - 1280x720 (720p)
       - 3840x2160 (4K)
       - 2560x1440 (2K)
     - 竖屏模式：
       - 1080x1920 (竖屏1080p) - 推荐
       - 720x1280 (竖屏720p)
       - 2160x3840 (竖屏4K)
       - 1440x2560 (竖屏2K)
   - **帧率 (FPS)**：
     - 24 - 电影标准
     - 25 - PAL 标准
     - 30 - 推荐（通用）
     - 60 - 高帧率
   - **视频编码**：
     - libx264 (H.264) - 推荐（兼容性好）
     - libx265 (H.265/HEVC) - 高压缩比
     - mpeg4 - 传统格式

5. **配置水印设置** ✨ 新增
   - **水印文字**：自定义水印内容（默认："老猿世界观察"）
   - **文字颜色**：
     - white (白色) - 推荐（适合深色背景）
     - black (黑色) - 适合浅色背景
     - red (红色)
     - yellow (黄色)
     - blue (蓝色)
     - green (绿色)
   - **字体选择**：
     - arial.ttf - 英文默认
     - simhei.ttf (黑体) - 推荐中文字体
     - simsun.ttc (宋体)
     - msyh.ttc (微软雅黑)
     - simkai.ttf (楷体)
   - **透明度**：0.1 ~ 1.0（默认 0.5）
   - **位置**：
     - 右上角 (topright) - 推荐
     - 左上角 (topleft)
     - 右下角 (bottomright)
     - 左下角 (bottomleft)
   - **启用/禁用**：勾选框控制是否添加水印

6. **指定输出文件**
   - 默认：`output.mp4`
   - 可通过"浏览"按钮选择路径
   - 支持格式：MP4, AVI, MKV

7. **生成视频**
   - 点击绿色"生成视频"按钮
   - 等待处理完成（显示进度）
   - 完成后自动弹出提示

## 🛠️ 技术实现

### 依赖工具
- **FFmpeg**：必须安装并配置到系统 PATH
- **Pillow**：用于读取图片信息

### FFmpeg 命令结构

**无水印：**
```bash
ffmpeg -loop 1 -i <图片> -i <音频> \
  -c:v <视频编码> -c:a aac -b:a 192k \
  -shortest -r <帧率> -s <分辨率> \
  -pix_fmt yuv420p -y <输出文件>
```

**带水印：**
```bash
ffmpeg -loop 1 -i <图片> -i <音频> \
  -vf "drawtext=text='水印文字':fontfile=<字体路径>:fontsize=<大小>:fontcolor=<颜色>@<透明度>:x=<X坐标>:y=<Y坐标>" \
  -c:v <视频编码> -c:a aac -b:a 192k \
  -shortest -r <帧率> -s <分辨率> \
  -pix_fmt yuv420p -y <输出文件>
```

### 参数说明
- `-loop 1`: 循环播放图片
- `-shortest`: 以最短的流为准（音频结束则视频结束）
- `-vf "drawtext..."`: 视频滤镜，用于添加文字水印
- `-c:v`: 视频编码器
- `-c:a aac`: 音频编码为 AAC
- `-b:a 192k`: 音频比特率
- `-r`: 帧率
- `-s`: 分辨率
- `-pix_fmt yuv420p`: 像素格式（兼容性最好）
- `-y`: 自动覆盖已存在的输出文件

### 水印自适应算法
```python
# 字体大小根据分辨率自适应（基准：1080p = 36px）
font_size = 36 * (当前高度 / 1080)

# 边距也自适应
margin = 20 * (当前高度 / 1080)

# 示例：
# - 1080p (1920x1080): 字体36px, 边距20px
# - 720p (1280x720): 字体24px, 边距13px
# - 4K (3840x2160): 字体72px, 边距40px
# - 竖屏1080p (1080x1920): 字体64px, 边距36px
```

## 📊 界面设计

```
┌──────────────────────────────────────────────────────────┐
│  [文本转音频 (Gemini-TTS)]  [音频合成视频] ⭐          │
├──────────────────────────────────────────────────────────┤
│                                                           │
│  音频文件:  [___________________________] [选择音频]     │
│            未选择音频文件                                 │
│                                                           │
│  图片文件:  [___________________________] [选择图片]     │
│            未选择图片文件                                 │
│                                                           │
│  输出视频:  [output.mp4_________________] [浏览]         │
│                                                           │
│  视频方向:  ◉ 横屏 (16:9)   ○ 竖屏 (9:16) ✨           │
│                                                           │
│  ┌─ 视频参数 ──────────────────────────────┐            │
│  │                                           │            │
│  │  分辨率:      [1920x1080 (1080p) ▼]     │            │
│  │  帧率 (FPS):  [30 ▼]                     │            │
│  │  视频编码:    [libx264 (H.264) ▼]       │            │
│  │                                           │            │
│  └───────────────────────────────────────────┘            │
│                                                           │
│                [     生成视频     ]                       │
│                   (绿色大按钮)                            │
│                                                           │
│  状态: 正在生成视频...                                   │
│                                                           │
└──────────────────────────────────────────────────────────┘

注: 选择竖屏后，分辨率选项自动切换为竖屏比例 (9:16)
```

## ⚙️ 系统要求

### 必需
- Python 3.8+
- FFmpeg（已安装并在 PATH 中）
- Pillow 库

### 安装 FFmpeg
**Windows:**
```powershell
# 使用 Chocolatey
choco install ffmpeg

# 或手动下载
# https://ffmpeg.org/download.html
```

**验证安装:**
```powershell
ffmpeg -version
ffprobe -version
```

## 🎯 使用场景

1. **音频封面视频**
   - 为播客/音频内容创建可上传到 YouTube 的视频（横屏）
   - 使用专辑封面或频道 Logo 作为静态背景

2. **短视频制作** ✨
   - 竖屏模式适配抖音、快手、视频号
   - 快速制作音频配图短视频内容
   - 完美适配移动端观看体验

3. **简易视频制作**
   - 快速将解说音频配上背景图
   - 制作简单的幻灯片式视频

4. **工作流集成**
   - 结合标签页1：文本 → 音频 → 视频
   - 支持横竖屏切换，适应不同平台
   - 一站式内容生产

## 📝 注意事项

1. **FFmpeg 依赖**
   - 确保 FFmpeg 正确安装
   - 如果找不到命令，会显示错误提示

2. **横竖屏选择**
   - 选择视频方向后，分辨率选项会自动更新
   - 横屏 (16:9) 适合 YouTube、B站等
   - 竖屏 (9:16) 适合抖音、快手、视频号等短视频平台

3. **水印设置** ✨
   - 水印大小会根据分辨率自动调整，保持视觉一致性
   - 建议使用半透明度（0.5）以不影响内容观看
   - 中文内容建议使用黑体或微软雅黑字体
   - Windows系统会自动查找系统字体目录

4. **文件大小**
   - 高分辨率（4K）会产生较大文件
   - 推荐使用 1080p 以平衡质量和文件大小

4. **处理时间**
   - 处理时间取决于音频长度和视频参数
   - 长音频 + 高分辨率 = 更长处理时间
   - 添加水印会略微增加处理时间（通常可忽略）

5. **图片格式**
   - 支持透明背景（PNG）
   - 自动转换为视频兼容格式
   - 图片会被缩放至指定分辨率

## 🐛 故障排除

### 问题：找不到 ffmpeg 命令
**解决方案：**
- 确认 FFmpeg 已安装
- 将 FFmpeg 路径添加到系统 PATH
- 重启终端/IDE

### 问题：视频生成失败
**解决方案：**
- 检查音频和图片文件是否损坏
- 尝试更换编码器（如从 libx265 改为 libx264）
- 查看错误消息获取详细信息

### 问题：视频无法播放
**解决方案：**
- 使用 VLC 或其他兼容性好的播放器
- 确认使用 H.264 编码（兼容性最好）
- 检查像素格式设置

## 🚀 未来改进方向

- [x] ✅ 横竖屏选择功能（已完成）
- [x] ✅ 根据方向自动调整分辨率选项（已完成）
- [x] ✅ 自适应水印功能（已完成）
- [x] ✅ 可自定义水印文字、颜色、字体、位置（已完成）
- [ ] 添加视频预览功能
- [ ] 支持批量处理
- [ ] 添加视频滤镜效果（模糊、锐化、色彩调整等）
- [ ] 支持图片序列（幻灯片）
- [ ] 实时进度条显示
- [ ] 支持图片水印（Logo叠加）
- [ ] 添加多行水印支持
- [ ] 支持更多视频格式和编码
- [ ] 添加更多短视频平台预设（抖音、快手、Instagram等）

## 📚 相关文档

- [FFmpeg 官方文档](https://ffmpeg.org/documentation.html)
- [Gemini-TTS 迁移文档](./GEMINI_TTS_MIGRATION.md)
- [项目 README](./README.markdown)
